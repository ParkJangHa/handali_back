name: Deploy to AWS EC2

on:
  push:
    branches:
      - release/* #realeaseë¡œ ì‹œìž‘í•˜ëŠ” ëª¨ë“  ë¸Œëžœì¹˜ì—ì„œ í‘¸ì‹œí• ë•Œ

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.4
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ubuntu
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |

            # 1. main ë¸Œëžœì¹˜ ì½”ë“œ ê°€ì ¸ì˜¤ê¸° 
            cd /home/ubuntu/handali_back 
            git pull origin main


            # 2. gradlew ì´ ì¡´ìž¬í•˜ëŠ” ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ë° ê¶Œí•œ ì„¤ì •
            cd handali 
            chmod +x gradlew

            # 3. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
            ./gradlew clean build

             

            # 4. ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (PID íŒŒì¼ì„ ì´ìš©)
            if [ -f app.pid ]; then
              old_pid=$(cat app.pid)

              # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ìƒ ì¢…ë£Œ ì‹œë„
              kill $old_pid || true
              sleep 5

              # ì•„ì§ ì‚´ì•„ìžˆìœ¼ë©´, ê°•ì œ ì¢…ë£Œ
              if ps -p $old_pid > /dev/null; then
                kill -9 $old_pid || true
                sleep 2
              fi

              rm -f app.pid
            fi

            # 5. ë¹Œë“œëœ íŒŒì¼ ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰í•˜ê¸°
            echo "==== Running application in background ===="
            nohup java -jar build/libs/handali-0.0.1-SNAPSHOT.jar > app.log 2>&1 &
            echo $! > app.pid

            # 6. ì‹¤í–‰ëœ í”„ë¡œì„¸ìŠ¤ê°€ ì •ìƒë™ìž‘ í•˜ëŠ”ì§€ í™•ì¸
              sleep 2
              new_pid=$(cat app.pid)
              if ps -p $new_pid > /dev/null; then
                echo "âœ… Application started successfully with PID $new_pid"
              else
                echo "ðŸš¨ Application failed to start!"
                exit 1
              fi



            echo "==== Deployment Finished! ===="
